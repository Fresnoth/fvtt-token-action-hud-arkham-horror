name: Create Module Files For GitHub Release
name: Create Module Files For GitHub Release

env:
  # The URL used for the module's "Project URL" link on FoundryVTT's website.
  project_url: "https://github.com/${{ github.repository }}"

  # A URL that will always point to the latest manifest.
  # FoundryVTT uses this URL to check whether the current module version that
  # is installed is the latest version. This URL should NOT change.
  latest_manifest_url: "https://github.com/${{ github.repository }}/releases/latest/download/module.json"

  # The URL to the module archive associated with the module release being processed.
  # For manual runs, this uses the provided input tag.
  release_module_url: "https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name || inputs.tag }}/module.zip"

  # Minimum Arkham Horror RPG FVTT system version required for this module.
  required_system_min_version: "13.0.32"

on:
  release:
    types: [published]

  # Allow re-running packaging manually (useful if Actions were disabled when the release was published).
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to package (e.g. v13.0.0)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Determine Release Metadata
        id: meta
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name || inputs.tag }}"
          if [ -z "$TAG" ]; then
            echo "No tag available. For manual runs, provide inputs.tag (e.g. v13.0.0)." >&2
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.meta.outputs.tag }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Build (Rollup)
        run: npm run build

      - name: Modify Module Manifest With Release-Specific Values
        env:
          VERSION: ${{ steps.meta.outputs.version }}
          URL: ${{ env.project_url }}
          MANIFEST: ${{ env.latest_manifest_url }}
          DOWNLOAD: ${{ env.release_module_url }}
          SYSTEM_MIN: ${{ env.required_system_min_version }}
        run: |
          jq --arg VERSION "$VERSION" \
             --arg URL "$URL" \
             --arg MANIFEST "$MANIFEST" \
             --arg DOWNLOAD "$DOWNLOAD" \
             --arg SYSTEM_MIN "$SYSTEM_MIN" \
             '.version=$VERSION
              | .url=$URL
              | .manifest=$MANIFEST
              | .download=$DOWNLOAD
              | .esmodules=["./scripts/fvtt-token-action-hud-arkham-horror.min.js"]
              | (.relationships.systems[] | select(.id=="arkham-horror-rpg-fvtt") | .compatibility.minimum)=$SYSTEM_MIN' \
             module.json > module.json.tmp
          mv module.json.tmp module.json

      - name: Create Module Archive
        run: |
          zip \
            --recurse-paths \
            ./module.zip \
            module.json \
            readme.md \
            LICENSE \
            languages/ \
            scripts/ \
            styles/

      - name: Update Release with Files
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          name: ${{ github.event.release.name || steps.meta.outputs.tag }}
          draft: ${{ github.event.release.draft || false }}
          prerelease: ${{ github.event.release.prerelease || false }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: "./module.json, ./module.zip"
          tag: ${{ steps.meta.outputs.tag }}
          body: ${{ github.event.release.body || '' }}
          # Don't forget to add a backslash at the end of the line for any
